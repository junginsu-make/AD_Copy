# Pltt. AD Copy 시스템 아키텍처

**최종 업데이트**: 2025-11-18

## 시스템 개요

Pltt. AD Copy는 AI 기반 광고 카피 생성 플랫폼으로, 카피라이팅 이론 + 3가지 독립 광고 소스 + 최신 AI 모델을 결합한 시스템입니다.

### 핵심 차별점
1. **3가지 독립 광고 수집**: 네이버, 구글, Perplexity (종합 평가)
2. **실시간 DB 누적**: 모든 광고 자동 저장 (Supabase)
3. **피드백 학습**: 사용자 평가로 AI 성능 향상
4. **수동 입력**: 사용자가 직접 좋은 광고 추가 가능

---

## 핵심 구조

### 3계층 아키텍처

```
┌─────────────────────────────────────────────┐
│          프레젠테이션 계층                    │
│  - Next.js App Router                       │
│  - React 컴포넌트                           │
│  - Tailwind CSS                             │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│          비즈니스 로직 계층                   │
│  - 의도 추출 서비스                          │
│  - 카피 생성 서비스                          │
│  - 광고 레퍼런스 서비스                      │
│  - 프롬프트 최적화 서비스                    │
│  - 카피라이팅 전략 서비스                    │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│          인프라 계층                         │
│  - LLM 프로바이더 (GPT/Gemini/Claude)       │
│  - Supabase (PostgreSQL)                    │
│  - Firecrawl (웹 스크래핑)                  │
│  - Perplexity AI (광고 검색)                │
└─────────────────────────────────────────────┘
```

---

## 데이터 흐름

### 1. 카피 생성 (Variety 모드)

```
사용자 입력: "30대 여성 화장품, 감성적으로"
  ↓
IntentExtractionService (Gemini Flash)
  - 제품명: 화장품
  - 타겟: 30대 여성
  - 톤: emotional
  ↓
ProductionAdReferenceService (3가지 독립 소스 병렬 수집)
  1. 네이버 직접 (Firecrawl): 30개
  2. 구글 직접 (Firecrawl): 30개
  3. Perplexity 독립 (최신 트렌드): 30개
  ━━━━━━━━━━━━━━━━━━━━
  총 90개 수집
  ↓
의도 기반 필터링
  - 키워드 매칭: "화장품", "30대", "여성"
  - 타겟 매칭
  - 톤 매칭: emotional
  ↓
  60개 선택
  ↓
중복 제거 및 품질 필터
  - 이모지 제거
  - UI 요소 제거
  - 최소 길이 체크
  ↓
  40개 최종 선택
  ↓
adReferences 테이블에 저장 (Supabase)
  - collectedVia: "auto-collection"
  - performanceScore: 0.5 (기본)
  ↓
CopyVarietyGenerator
  - 8가지 스타일 병렬 생성
  - 각 스타일별 최적 모델 자동 선택
  - 카피라이팅 공식/트리거 적용
  - 광고 레퍼런스 5-20개 프롬프트에 주입
  ↓
8가지 스타일 × 3개 = 24개 카피 생성
  - ad_reference → GPT-5
  - emotional → GPT-5
  - data_driven → Gemini 2.5 Pro
  - direct → Gemini 2.5 Flash
  - trusted → GPT-5
  - storytelling → Claude 4.5
  - urgent → Gemini 2.5 Flash
  - premium → Claude 4.5
  ↓
copies 테이블에 저장 (Supabase)
  - userId, prompt, content, modelUsed, cost, metadata
  ↓
users 테이블 API 사용량 업데이트
  - apiQuotaUsed += 24
  ↓
결과 반환 (24개 카피)
```

### 2. 대화형 카피 생성

```
사용자: "화장품 광고 만들고 싶어요"
  ↓
IntentExtractionService
  - 제품명: 화장품
  ↓
ProductionAdReferenceService (첫 대화에만)
  - 3가지 소스 병렬 수집 (90개)
  - 의도 필터링 → 40개
  - adReferences 테이블 저장
  - 프롬프트에는 5개만 사용
  - context.adReferenceSection에 저장 (재사용)
  ↓
ConversationalCopyService
  - 시스템 프롬프트 구성:
    * 전문 카피라이터 페르소나
    * 광고 레퍼런스 5개 주입
    * 대화 컨텍스트 포함
    * 이모지 사용 금지 명시
  ↓
conversationSessions 테이블 생성
  - userId, context (광고 레퍼런스 포함)
  ↓
Claude Sonnet 4.5 호출
  - temperature: 0.8 (창의성)
  - max_tokens: 2000
  - 대화 히스토리 포함
  ↓
카피 추출 및 저장
  - copies 테이블 저장 (실시간 업데이트)
  - conversationTurns 저장 (대화 내역)
  ↓
사용자: "더 짧게 해줘" (개선 요청)
  ↓
기존 광고 레퍼런스 재사용 (재수집 안 함!) ⚡
  - context.adReferenceSection 사용
  - 40초 → 3초로 단축
  ↓
Claude 호출 (대화 히스토리 + 광고 레퍼런스)
  ↓
개선된 카피 생성
  ↓
copies 테이블 저장
  ↓
대화창에 자연스럽게 이어짐
```

---

## 핵심 서비스

### 1. IntentExtractionService
**역할**: 사용자 입력에서 의도 추출

**추출 정보**:
- productName: 제품/서비스명
- targetAudience: 타겟 고객
- tone: 톤 (emotional, urgent, premium 등)
- keyBenefits: 핵심 혜택
- keywords: 키워드
- emotionalTriggers: 감정 트리거

**사용 모델**: Gemini 2.5 Flash (빠르고 저렴)

---

### 2. ProductionAdReferenceService
**역할**: 3가지 독립 소스에서 광고 수집

**수집 소스 (병렬 처리)**:

1. **네이버 직접** (Firecrawl):
   - 검색 쿼리: "{키워드} 광고"
   - 수집 개수: 최대 30개
   - 방식: 검색 결과 스크래핑

2. **구글 직접** (Firecrawl):
   - 검색 쿼리: "{키워드} 광고 마케팅 홍보"
   - 수집 개수: 최대 30개
   - 방식: 검색 결과 스크래핑

3. **Perplexity 독립** (최신 트렌드):
   - 자연어 질문: "'{키워드}'와 관련된 최신 광고 카피 TOP 20"
   - 수집 개수: 최대 30개
   - 방식: AI 검색 (바이럴 광고, 성공 캠페인)
   - 파라미터: `return_citations: true`, `search_recency_filter: "year"`

**수집 흐름**:
```
총 90개 수집
  ↓
의도 기반 필터링 (filterByIntent)
  - 키워드 매칭
  - 타겟 매칭
  - 톤 매칭
  ↓
60개 선택
  ↓
중복 제거
  ↓
40개 최종
  ↓
프롬프트 사용: 5-20개
DB 저장: 40개 전체 (Supabase)
```

**품질 필터**:
- UI 요소 제거 (로그인, 메뉴 등)
- 이모지/이모티콘 제거
- 최소 길이 체크 (5자 이상)
- 의도 기반 필터링

**수동 카피 입력**:
- API: POST /api/ad-references/manual
- 기본 성능 점수: 0.7 (70점, 높음)
- isPremium: true
- 사용자가 직접 추가한 좋은 광고 관리

---

### 3. CopywritingStrategyService
**역할**: 의도 기반 최적 전략 수립

**선택 항목**:
- 카피라이팅 공식 (12가지)
- 심리 트리거 (24가지)
- 마스터 카피라이터 스타일 (14명)

**전략 수립 로직**:
```typescript
if (intent.tone === "emotional") {
  formula = "BAB" (Before-After-Bridge)
  triggers = ["스토리텔링", "감정적 연결"]
  style = "Gary Halbert"
}
```

---

### 4. CopyVarietyGenerator
**역할**: 8가지 스타일별 카피 병렬 생성

**스타일별 최적 모델**:
```typescript
VARIETY_MODEL_MAPPING = {
  ad_reference: "gpt-5",
  emotional: "gpt-5",
  data_driven: "gemini-2.5-pro",
  direct: "gemini-2.5-flash",
  trusted: "gpt-5",
  storytelling: "claude-sonnet-4-5",
  urgent: "gemini-2.5-flash",
  premium: "claude-sonnet-4-5",
}
```

**생성 방식**:
- 8개 스타일을 병렬로 동시 생성
- 각 스타일당 3개씩
- 총 24개 카피 생성
- 생성 시간: 35-45초

---

### 5. ConversationalCopyService
**역할**: 대화형 카피 생성

**핵심 메커니즘**:
1. 광고 레퍼런스 수집 (첫 대화에만)
2. 시스템 프롬프트에 레퍼런스 주입
3. 대화 히스토리 누적
4. 컨텍스트 유지
5. 점진적 개선

**사용 모델**: Claude Sonnet 4.5 전용

---

## 데이터베이스 스키마

### 핵심 테이블

```sql
-- 생성된 카피
copies (
  id, userId, prompt, generatedContent,
  charCount, tone, modelUsed, apiCost,
  metadata, createdAt
)

-- 광고 레퍼런스
adReferences (
  id, platform, adCopy, category,
  keywords, copywritingFormula, psychologicalTriggers,
  performanceScore, usageCount, successCount,
  collectedAt
)

-- 카피 피드백
copyFeedback (
  id, copyId, userId, rating,
  isFavorite, isUsed, feedbackText,
  actualCtr, actualConversionRate
)

-- 대화 세션
conversationSessions (
  id, userId, preferredModel, status,
  context, createdAt
)

-- 학습 로그
fewshotLearningLog (
  id, copyId, adReferenceId,
  resultQuality, userSatisfaction
)
```

---

## 학습 메커니즘

### 피드백 순환

**광고 레퍼런스 평가**:
```
광고 수집 → adReferences 테이블
  ↓
/admin/ad-references에서 사용자 평가 (1-5점)
  ↓
POST /api/ad-references/feedback
  ↓
평점 4-5점 → performanceScore +0.05
평점 1-2점 → performanceScore -0.05
  ↓
다음 카피 생성 시
  ↓
DynamicFewShotService.selectBestExamples()
  - performanceScore 높은 광고 우선
  - 평점 좋은 광고 우선
  ↓
좋은 광고만 프롬프트에 포함
  ↓
카피 품질 향상
```

**생성된 카피 평가**:
```
카피 생성 → copies 테이블
  ↓
/history에서 사용자 피드백
  - 평점 (1-5점)
  - 즐겨찾기
  - 실제 사용 여부
  - CTR/전환율 (선택)
  ↓
POST /api/feedback/submit
  ↓
copyFeedback 테이블 저장
  ↓
fewshotLearningLog 업데이트
  ↓
평점 4+ → adReferences.successCount++
  ↓
다음 카피 생성 시 성공 광고 우선 사용
```

**수동 카피 활용**:
```
사용자가 직접 좋은 광고 입력
  ↓
POST /api/ad-references/manual
  ↓
adReferences 테이블 저장
  - performanceScore: 0.7 (높음)
  - isPremium: true
  ↓
다음 카피 생성 시 우선 선택
```

---

## 성능 지표

### Variety 모드
- 생성 개수: 24개
- 생성 시간: 35-45초
- 평균 비용: $0.020-0.030
- 토큰 사용: 6,000-8,000개

### Multi 모드
- 생성 개수: 15개
- 생성 시간: 15-25초
- 평균 비용: $0.015-0.025
- 토큰 사용: 4,000-6,000개

### Single 모드
- 생성 개수: 10개
- 생성 시간: 5-10초
- 평균 비용: $0.010-0.015
- 토큰 사용: 2,000-3,000개

### 대화형 모드
- 턴당 비용: $0.005-0.015
- 응답 시간: 3-8초
- 토큰 사용: 1,000-3,000개/턴

---

## 품질 보장 시스템

### 1. 광고 레퍼런스 품질 필터
```typescript
filterByQuality(ads) {
  // 이모지 제거
  if (emojiRegex.test(adCopy)) return false;
  
  // 최소 길이
  if (adCopy.length < 5) return false;
  
  // UI 요소 제외
  if (adCopy.includes("로그인")) return false;
  
  return true;
}
```

### 2. 의도 기반 필터링
```typescript
filterByIntent(ads, intent, keywords) {
  // 키워드 매칭
  if (adText.includes(keyword)) return true;
  
  // 타겟 매칭
  if (adText.includes(targetAudience)) return true;
  
  // 톤 매칭
  if (tone === "emotional" && adText.includes("감성")) return true;
  
  return false;
}
```

### 3. 카피 검증
- 글자수 범위 준수
- 금지 단어 체크
- 플랫폼 규격 준수 (선택 시)

---

## 확장성

### 새로운 AI 모델 추가
1. `src/infrastructure/ai/` 에 프로바이더 추가
2. `LLMProviderFactory`에 등록
3. 비용 계산 함수 구현

### 새로운 카피 스타일 추가
1. `CopyVariety` 타입에 추가
2. `VARIETY_MODEL_MAPPING`에 최적 모델 지정
3. `getVarietyPrinciples`에 작성 원칙 추가

### 새로운 플랫폼 규격 추가
1. `src/domain/ad-platforms/platform-specs.ts` 에 규격 추가
2. 금지 단어, 글자수 제한 정의

---

## 참고 문서

- README.md - 프로젝트 개요
- 설치_가이드.md - 설치 방법
- TODO.md - 개발 계획
- system docs/ - 카피라이팅 이론 및 구현 가이드

